# ğŸŒ± í”„ë¡œì íŠ¸ í™˜ê²½ ì„¤ì •
## ëª©ì°¨

- í”„ë¡œì íŠ¸ ìƒì„±
- ë¼ì´ë¸ŒëŸ¬ë¦¬ ì‚´í´ë³´ê¸°
- View í™˜ê²½ì„¤ì •
- H2 ë°ì´í„°ë² ì´ìŠ¤ ì„¤ì¹˜
- JPAì™€ DB ì„¤ì •, ë™ì‘ í™•ì¸

&nbsp;

## í”„ë¡œì íŠ¸ ìƒì„±

- ìŠ¤í”„ë§ ë¶€íŠ¸ ìŠ¤íƒ€í„° (start.spring.io)
    - groupId: jpabook
    - artifactId: jpashop
- ì‚¬ìš© ê¸°ëŠ¥: web, thymeleaf, jpa, h2, lombok
    - Spring Web Starter: web ì• í”Œë¦¬ì¼€ì´ì…˜ ê°œë°œì— í•„ìš”
    - thymeleaf: ëª¨ë˜ ì„œë²„ì‚¬ì´ë“œ ìë°” í…œí”Œë¦¿ ì—”ì§„
    - Spring Data JPA: ìë°” Persistence API using Spring Data and Hibernate
    - h2: ë‚´ì¥í•´ ì‰½ê²Œ ì‹¤í–‰í•  ìˆ˜ ìˆëŠ” Database
    - lombok: ê°„ë‹¨í•œ ì–´ë…¸í…Œì´ì…˜ìœ¼ë¡œ ë°˜ë³µë˜ëŠ” ì½”ë“œë¥¼ ì¤„ì—¬ì£¼ëŠ” ê¸°ëŠ¥


í”„ë¡œì íŠ¸ ë‹¤ìš´ë¡œë“œ í›„ IntelliJë¡œ Import or Open

- í”„ë¡œì íŠ¸ë¥¼ ì‹¤í–‰í•´ë³´ë©´ tomcatì´ 8080 portì—ì„œ ì‹¤í–‰ì´ ë˜ì—ˆë‹¤ëŠ” ë¡œê·¸ê°€ ëœ¸

- IntelliJ > Preference > Plugins > Lombok
- IntelliJ > Preference > Build, Execution, Deployment > Compiler > Annotation Processors
- [ ]  Enable annotation processing ì„ íƒ

&nbsp;

## ë¼ì´ë¸ŒëŸ¬ë¦¬ ì‚´í´ë³´ê¸°

Projectì—ì„œ ì•„ë˜ì™€ ê°™ì´ ì‹¤í–‰í•˜ë©´ ì˜ì¡´ê´€ê³„ë¥¼ ë³´ì—¬ì¤Œ

```bash
$ ./gradlew dependencies
```


IntelliJì˜ ìš°ì¸¡ Gradle íƒ­ì—ì„œë„ dependency í™•ì¸ ê°€ëŠ¥


- `spring-boot-starter-web` ì•„ë˜ì—” embeddedëœ `tomcat`ê³¼ `webmvc`ê°€ ìˆìŒ.

Tomcatì€ Javaë¥¼ ì´ìš©í•œ ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ ë‹¤ì–‘í•œ ê·œê²©(Spec)ì„ ì¤€ìˆ˜í•˜ì—¬ JSP, HTML íŒŒì¼ë“¤ë¡œ êµ¬ì„±ëœ .war íŒŒì¼(ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ íŒŒì¼ë“¤ì„ ì••ì¶•í•´ë†“ì€ í•˜ë‚˜ì˜ íŒŒì¼)ì„ ë°°í¬í•´ì£¼ëŠ” ì—”ì§„

- `spring-boot-starter-data-jpa` ì•„ë˜ì—” `core`, `aop`, `jdbc`, `HikariCP`(ì»¤ë„¥ì…˜ í’€), `hibernate`, `logging`(`logback`, `slf4j`- loggerë¥¼ ì°ëŠ” ì¸í„°í˜ì´ìŠ¤ë“¤ì˜ ëª¨ìŒ) ë“±ì´ ìˆìŒ.
- Testì—ì„œ `spring-boot-starter-test`ì—ëŠ” `junit`ê³¼ `mockito`, `assertj`ë“±ì´ ìˆìŒ.

### í•µì‹¬ ë¼ì´ë¸ŒëŸ¬ë¦¬

- Spring MVC
- Spring ORM
- JPA, í•˜ì´ë²„ë„¤ì´íŠ¸
- ìŠ¤í”„ë§ ë°ì´í„° JPA

### ê¸°íƒ€ ë¼ì´ë¸ŒëŸ¬ë¦¬

- H2 ë°ì´í„°ë² ì´ìŠ¤ í´ë¼ì´ì–¸íŠ¸
- ì»¤ë„¥ì…˜ í’€ (boot ê¸°ë³¸ì€ HikariCP)
- WEB (thymeleaf)
- ë¡œê¹… SLF4J & LobNack
- í…ŒìŠ¤íŠ¸

&nbsp;

## View í™˜ê²½ ì„¤ì •

- thymeleaf ê³µì‹ ì‚¬ì´íŠ¸: https://www.thymeleaf.org/
- ìŠ¤í”„ë§ ê³µì‹ íŠœí† ë¦¬ì–¼: https://spring.io/guides/gs/serving-web-content/
- ìŠ¤í”„ë§ë¶€íŠ¸ ë©”ë‰´ì–¼: https://docs.spring.io/spring-boot/docs/2.1.6.RELEASE/reference/html/boot-features-developing-web-applications.html#boot-features-spring-mvc-template-engines
- **ìŠ¤í”„ë§ ë¶€íŠ¸ thymeleafê°€ viewName ë§¤í•‘**
    - `resources:templates/` + {ViewName} + `.html`

    ```java
    @Controller
      public class HelloController {
          @GetMapping("hello")
          public String hello(Model model) {
              model.addAttribute("data", "hello!!");
              return "hello";
          }
    }
    ```

    Controllerì—ì„œ `Model`ì— dataë¥¼ ì‹£ì–´ Viewì— ë„˜ê¹€ â†’ `return "ViewName"` (.htmlì´ ìƒëµë¨)

- **thymeleaf í…œí”Œë¦¿ì—”ì§„ ë™ì‘ í™•ì¸(hello.html) - ì„œë²„ì‚¬ì´ë“œ ë Œë”ë§**

```html
<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Hello</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
</head>
<body>
<p th:text="'ì•ˆë…•í•˜ì„¸ìš”. ' + ${data}" >ì•ˆë…•í•˜ì„¸ìš”. ì†ë‹˜</p>
</body>
</html>
```

ìˆœìˆ˜ html ë Œë”ë§ ì‹œ "ì•ˆë…•í•˜ì„¸ìš”. ì†ë‹˜"ì´ ì¶œë ¥, ì„œë²„ ì‚¬ì´ë“œ ë Œë”ë§ ì‹œ ì•ˆë…•í•˜ì„¸ìš”. `data`ê°€ ì¶œë ¥.

- **ì •ì  í˜ì´ì§€ index.html í•˜ë‚˜ ë§Œë“¤ê¸°** `static/index.html`

```html
<!DOCTYPE HTML>
  <html xmlns:th="http://www.thymeleaf.org">
       
     <head>
        <title>Hello</title>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    </head>
    <body>
    Hello
    <a href="/hello">hello</a>
    </body>
</html>
```

ì°¸ê³ ) `spring-boot-devtools` ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì¶”ê°€í•˜ë©´, html íŒŒì¼ì„ ì»´íŒŒì¼ë§Œ í•´ì£¼ë©´ ì„œë²„ ì¬ì‹œì‘ ì—†ì´ View íŒŒì¼ ë³€ê²½ì´ ê°€ëŠ¥í•˜ë‹¤.

```java
implementation 'org.springframework.boot:spring-boot-devtools'
```

html íŒŒì¼ ì»´íŒŒì¼ ë°©ë²•: ë©”ë‰´ build â†’ Recompile

&nbsp;

## H2 ë°ì´í„°ë² ì´ìŠ¤ ì„¤ì¹˜

ê°œë°œì´ë‚˜ í…ŒìŠ¤íŠ¸ ìš©ë„ë¡œ ê°€ë³ê³  í¸ë¦¬í•œ DB, ì›¹ í™”ë©´ ì œê³µ

- ë°ì´í„°ë² ì´ìŠ¤ íŒŒì¼ ìƒì„± ë°©ë²•
    - `jdbc:h2:~/jpashop` (ìµœì†Œ í•œë²ˆ, ì„¸ì…˜í‚¤ ìœ ì§€í•œ ìƒíƒœë¡œ ì‹¤í–‰)
    - `~/jpashop.mv.db` íŒŒì¼ ìƒì„± í™•ì¸
    - ì´í›„ ë¶€í„°ëŠ” `jdbc:h2:tcp://localhost/~/jpashop` ì´ë ‡ê²Œ ì ‘ì†

&nbsp;

## JPAì™€ DB ì„¤ì •, ë™ì‘ í™•ì¸

`**main/resources/application.yml**`

```yaml
spring:
  datasource:
    url: jdbc:h2:tcp://localhost/~/jpashop;MVCC=TRUE
    username: sa
    password:
    driver-class-name: org.h2.Driver

  jpa:
    hibernate:
      ddl-auto: create
    properties:
      hibernate:
#        show_sql: true
        format_sql: true

logging:
  level:
    org.hibernate.SQL: debug
```

- `ddl-auto: create` ì˜µì…˜ì€ ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹¤í–‰ ì‹œì ì— í…Œì´ë¸”ì„ drop í•˜ê³ , ë‹¤ì‹œ ìƒì„±í•œë‹¤.
- `show_sql` ì˜µì…˜ì€ System.out ì— í•˜ì´ë²„ë„¤ì´íŠ¸ ì‹¤í–‰ SQLì„ ë‚¨ê¸´ë‹¤.
- `org.hibernate.SQL` ì˜µì…˜ì€ loggerë¥¼ í†µí•´ í•˜ì´ë²„ë„¤ì´íŠ¸ ì‹¤í–‰ SQLì„ ë‚¨ê¸´ë‹¤.

ì£¼ì˜) application.yml ê°™ì€ yml íŒŒì¼ì€ ë„ì–´ì“°ê¸°(ìŠ¤í˜ì´ìŠ¤) 2ì¹¸ìœ¼ë¡œ ê³„ì¸µì„ ë§Œë“ ë‹¤.

### ë™ì‘ í•˜ëŠ”ì§€ í™•ì¸í•˜ê¸°

**íšŒì› ì—”í‹°í‹°**

```java
@Entity
@Getter @Setter
public class Member {

    @Id @GeneratedValue
    private Long id;
    private String username;

}
```

**íšŒì› ë¦¬í¬ì§€í† ë¦¬**

```java
@Repository
public class MemberRepository {

    @PersistenceContext
    private EntityManager entityManager;

    public Long save(Member member) {
        entityManager.persist(member);
        return member.getId();
    }

    public Member findById(Long id) {
        return entityManager.find(Member.class, id);
    }
}
```

***@PersistenceContext*** ì–´ë…¸í…Œì´ì…˜ì´ ìˆìœ¼ë©´, ìŠ¤í”„ë§ ë¶€íŠ¸ê°€ ì—”í‹°í‹° ë§¤ë‹ˆì €ë¥¼ ìƒì„±í•´ ì£¼ì… ì‹œì¼œì¤€ë‹¤.

- `save()`ì—ì„œ Memberê°€ ì•„ë‹Œ `Member.getId()`ë¥¼ ë°˜í™˜í•˜ëŠ” ì´ìœ : ì»¤ë§¨ë“œì™€ ì¿¼ë¦¬ë¥¼ ë¶„ë¦¬í•˜ë¼  
ì €ì¥ì€ side effectë¥¼ ì¼ìœ¼í‚¬ ìˆ˜ ìˆëŠ” ì»¤ë§¨ë“œì´ê¸° ë•Œë¬¸ì— ë¦¬í„´ê°’ì„ ê±°ì˜ ë§Œë“¤ì§€ ì•ŠëŠ”ë‹¤. Id ì •ë„ ìˆìœ¼ë©´ ë‹¤ìŒì— ë‹¤ì‹œ ì¡°íšŒí•  ìˆ˜ ìˆìœ¼ë‹ˆ Idë§Œ ë°˜í™˜í•˜ê²Œ í•œë‹¤.

**í…ŒìŠ¤íŠ¸**

MemberRepositoryì˜ testë‹ˆ @Autowiredë¡œ memberRepository Injectionì„ ë°›ëŠ”ë‹¤.

```java
@RunWith(SpringRunner.class)
@SpringBootTest
public class MemberRepositoryTest {

    @Autowired
    MemberRepository memberRepository;

    @Test
    public void save() {
        //given
        Member member = new Member();
        member.setUsername("member1");

        //when
        Long savedId = memberRepository.save(member);
        Member findMember = memberRepository.findById(savedId);

        //then
        Assertions.assertThat(savedId).isEqualTo(findMember.getId());
        Assertions.assertThat(member.getUsername()).isEqualTo(findMember.getUsername());
		    Assertions.assertThat(findMember).isEqualTo(member);
		}
}
```

**í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì‹œ ì—ëŸ¬**: *No EntityManager with actual transaction available for current thread*  
â†’ EntityManagerë¥¼ í†µí•œ ëª¨ë“  ë°ì´í„° ë³€ê²½ì€ í•­ìƒ transaction ì•ˆì—ì„œ ì´ë£¨ì–´ì ¸ì•¼ í•œë‹¤.  
â†’ (Repository ë˜ëŠ” ë©”ì„œë“œì— *@Transactional*ì„ ê±¸ ìˆ˜ ìˆì§€ë§Œ) ì¼ë‹¨ Testì— ì¶”ê°€í•´ì¤€ë‹¤.

**í…ŒìŠ¤íŠ¸ ì„±ê³µ**: H2 ë°ì´í„°ë² ì´ìŠ¤ì— Member í…Œì´ë¸”ì´ ìƒì„±ëœ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.  
*@Transactional*  ì–´ë…¸í…Œì´ì…˜ì´ í…ŒìŠ¤íŠ¸ì— ìˆìœ¼ë©´ í…ŒìŠ¤íŠ¸ í›„ Rollbackì„ í•˜ë¯€ë¡œ, ì €ì¥ëœ ë°ì´í„°ëŠ” ì—†ë‹¤.  
*@Rollback(false)* ì–´ë…¸í…Œì´ì…˜ ì¶”ê°€ ì‹œ Rollbackì—†ì´ ì»¤ë°‹í•´ í…ŒìŠ¤íŠ¸ ë‚´ìš©ì´ DBì— ì €ì¥ëœë‹¤.


`Assertions.assertThat(findMember).isEqualTo(member);` ê²°ê³¼ëŠ” ë‘ ê°ì²´ê°€ ë™ì¼  
â†’ ê°™ì€ íŠ¸ëœì­ì…˜ ì•ˆì—ì„œ ë°ì´í„°ë¥¼ ì¡°íšŒí•˜ê³  ì €ì¥í•˜ë©´ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ê°€ ë™ì¼í•˜ë‹¤. ê°™ì€ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ ì•ˆì—ì„œëŠ” `id`(ì‹ë³„ì)ê°’ì´ ê°™ìœ¼ë©´ ê°™ì€ ì—”í‹°í‹°ë¡œ ì‹ë³„í•œë‹¤. 1ì°¨ ìºì‹œì— ì €ì¥ëœë‹¤.

### ì¿¼ë¦¬ íŒŒë¼ë¯¸í„° ë¡œê·¸ ë‚¨ê¸°ê¸°

- `org.hibernate.type: trace`

ì¿¼ë¦¬ ìƒì—ëŠ” "?"ë¡œ ë‚¨ì§€ë§Œ SQL ì‹¤í–‰ íŒŒë¼ë¯¸í„°ë¥¼ ë¡œê·¸ë¡œ ë‚¨ê¸´ë‹¤.

- [https://github.com/gavlyukovskiy/spring-boot-data-source-decorator](https://github.com/gavlyukovskiy/spring-boot-data-source-decorator)

```java
implementation 'com.github.gavlyukovskiy:p6spy-spring-boot-starter:1.5.6'
```

ì°¸ê³ ) ì¿¼ë¦¬ íŒŒë¼ë¯¸í„°ë¥¼ ë¡œê·¸ë¡œ ë‚¨ê¸°ëŠ” ì™¸ë¶€ ë¼ì´ë¸ŒëŸ¬ë¦¬ëŠ” ì‹œìŠ¤í…œ ìì›ì„ ì‚¬ìš©í•˜ë¯€ë¡œ, ê°œë°œ ë‹¨ê³„ì—ì„œëŠ” í¸í•˜ ê²Œ ì‚¬ìš©í•´ë„ ëœë‹¤. í•˜ì§€ë§Œ ìš´ì˜ì‹œìŠ¤í…œì— ì ìš©í•˜ë ¤ë©´ ê¼­ ì„±ëŠ¥í…ŒìŠ¤íŠ¸ë¥¼ í•˜ê³  ì‚¬ìš©í•˜ëŠ” ê²ƒì´ ì¢‹ë‹¤.
