# 🌱 Spring DB 접근 기술

## H2 데이터베이스 설치

개발이나 테스트 용도로 가볍고 편리한 DB, 웹 화면 제공

- 권한 주기  
`chmod 755 h2.sh`
- 실행  
`./h2.sh`
- 데이터베이스 파일 생성 방법  
jdbc:h2:~/test (최초 한번)  
~/test.mv.db 파일 생성 확인  
이후부터는 jdbc:h2:tcp://localhost/~/test 이렇게 접속

&nbsp;

## 순수 JDBC

### 환경 설정

**build.gradle 파일에 jdbc, h2 데이터베이스 관련 라이브러리 추가**

```java
implementation 'org.springframework.boot:spring-boot-starter-jdbc'
runtimeOnly 'com.h2database:h2'
```

Java는 DB를 연결하려면 `jdbc-driver`가 꼭 필요

**스프링 부트 데이터베이스 연결 설정 추가**

`resources/application.properties`

```java
spring.datasource.url=jdbc:h2:tcp://localhost/~/test
spring.datasource.driver-class-name=org.h2.Driver
spring.datasource.username=sa
```

접속 정보 경로 넣기

### **JDBC 회원 리파지토리 구현**

이렇게 JDBC API로 직접 코딩하는 것은 20년 전 이야기이다. 따라서 고대 개발자들이 이렇게 고생하고 살았구나 생각하고, 정신건강을 위해 참고만 하고 넘어가자.

**Jdbc 회원 리포지토리**

기존에 MemoryMemberRepository로 만들어놓은 구현체를 db와 연동하기 위해 JDBC로 대체

DB를 붙이려면 `dataSource`가 필요, Spring에게 주입받아야 함  
→ `application.properties`에서 setting해놓은 대로 Spring이 dataSource 접속정보를 만들어놓고 주입해줌.

```java
private final DataSource dataSource;

public JdbcMemberRepository(DataSource dataSource) {
		this.dataSource = dataSource;
}
```

**스프링 설정 변경**

```java
@Configuration
public class SpringConfig {

    private final DataSource dataSource;

    @Autowired
    public SpringConfig(DataSource dataSource) {
        this.dataSource = dataSource;
    }

    @Bean
    public MemberService memberService() {
        return new MemberService(memberRepository());
    }

    @Bean
    public MemberRepository memberRepository() {
        return new JdbcMemberRepository(dataSource);
    }
}
```

- DataSource는 데이터베이스 커넥션을 획득할 때 사용하는 객체다.  
스프링 부트는 데이터베이스 커넥션 정보를 바탕으로 DataSource를 생성하고 스프링 빈으로 만들어둔다. 그래서 DI를 받을 수 있다.
- JdbcMemberRepository만 생성하고, Config만 바꿔주면 다른 코드를 수정할 필요 없이 MemberRepository 구현체를 변경 가능  
→ interface는 그대로 두고 구현체를 바꿀 수 있다. (다형성 활용)

    <img width="836" alt="스크린샷 2021-01-22 오후 2 09 47" src="https://user-images.githubusercontent.com/45806836/105449312-7d8d8b00-5cbb-11eb-9813-788a95366a80.png">

- 개방-폐쇄 원칙(**OCP**, Open-Closed Principle)  
→ 확장에는 열려있고, 수정, 변경에는 닫혀있다.
- 스프링의 **DI** (Dependencies Injection)을 사용하면 **기존 코드를 전혀 손대지 않고, 설정만으로 구현 클래스를 변경**할 수 있다.
- 데이터를 DB에 저장하므로 스프링 서버를 다시 실행해도 데이터가 안전하게 저장된다.

&nbsp;

## 스프링 통합 테스트

스프링 컨테이너와 DB까지 연결한 통합 테스트를 진행해보자.

```java
@SpringBootTest
@Transactional
class MemberServiceIntegrationTest {

    @Autowired MemberService memberService;
    @Autowired MemberRepository memberRepository;

		...

}
```

*@SpringBootTest* : 스프링 컨테이너와 테스트를 함께 실행한다.

*@Transactional* : 테스트 케이스에 이 애노테이션이 있으면, 테스트 시작 전에 트랜잭션을 시작하고, 테스트 완료 후에 항상 롤백한다. 이렇게 하면 DB에 데이터가 남지 않으므로 다음 테스트에 영향을 주지 않는다.

단위 테스트는 주로 서비스 로직에 적용한다. 그런데 DB를 연동하면 단위 테스트가 어려워진다.

그래서 테스트 전용 가짜 repository를 만들어서 테스트 시점에 넣어주어야 한다. 이것을 mock 객체라고 한다.

단순히 테스트를 위해서 진짜 db가 아니라 가짜 객체를 하나 만들어서 넣어주는 것이다.

그런데 일일이 이런 객체를 만들면 개발자가 너무 귀찮으니까 실무에서는 mockito 같은 가짜 객체를 만들어주는 라이브러리를 주로 사용한다.
